<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>座位预约 - 自习室管理系统</title>
    <head>
    <meta charset="UTF-8">
    <title>自习室会员管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
    <!-- 添加图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .reservation-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }
        .ending-soon {
            border-left-color: #ffc107 !important;
            animation: pulse 2s infinite;
        }
        .extended {
            border-left-color: #28a745 !important;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .countdown {
            font-weight: bold;
            color: #dc3545;
        }
        .extend-controls {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">自习室管理系统</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="/">首页</a></li>
                <li class="nav-item"><a class="nav-link active" href="/reservations">座位预约</a></li>
                <li class="nav-item"><a class="nav-link" href="/reservations/history">预约历史</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                 <li class="nav-item">
                     <span class="navbar-text text-white me-3">欢迎, <span sec:authentication="name"></span>!</span>
                     <a class="btn btn-outline-light" onclick="document.getElementById('logout-form').submit();">退出登录</a>
                 <form action="/logout" method="post" id="logout-form" style="display: none;"></form>
                 </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- 成功/错误消息 -->
    <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:switch="${param.success[0]}">
            <span th:case="reservation_created"><i class="fas fa-check-circle"></i> 预约创建成功！</span>
            <span th:case="reservation_cancelled"><i class="fas fa-times-circle"></i> 预约已取消！</span>
            <span th:case="complaint_submitted"><i class="fas fa-paper-plane"></i> 投诉已提交！</span>
        </span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- 左侧：预约座位 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chair"></i> 预约座位</h5>
                </div>
                <div class="card-body">
                    <form action="/reservations" method="post">
                        <div class="mb-3">
                            <label for="seatId" class="form-label">选择座位</label>
                            <select id="seatId" name="seatId" class="form-select" required>
                                <option value="">请选择座位</option>
                                <option th:each="seat : ${seats}" th:value="${seat.id}" th:text="${seat.seatNumber}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startTime" class="form-label">开始时间</label>
                            <input type="datetime-local" id="startTime" name="startTime" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="endTime" class="form-label">结束时间</label>
                            <input type="datetime-local" id="endTime" name="endTime" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="remarks" class="form-label">备注（可选）</label>
                            <input type="text" id="remarks" name="remarks" class="form-control" placeholder="学习内容、特殊需求等">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-calendar-plus"></i> 确认预约
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 投诉建议表单 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-comment-dots"></i> 投诉与建议</h5>
                </div>
                <div class="card-body">
                    <form action="/complaints" method="post">
                        <div class="mb-3">
                            <label for="title" class="form-label">标题</label>
                            <input type="text" id="title" name="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">内容</label>
                            <textarea id="content" name="content" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-paper-plane"></i> 提交
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 右侧：我的当前预约 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calendar-check"></i> 我的当前预约</h5>
                </div>
                <div class="card-body">
                    <div th:if="${reservations == null or reservations.isEmpty()}" class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">您当前没有有效的预约</p>
                    </div>
                    
                    <div th:if="${reservations != null and !reservations.isEmpty()}">
                        <div th:each="res : ${reservations}" class="reservation-card card mb-3"
                             th:classappend="${res.status == 'EXTENDED'} ? 'extended' : ''">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title">
                                            <i class="fas fa-chair"></i> 座位号: <span th:text="${res.seat.seatNumber}"></span>
                                            <span th:if="${res.status == 'EXTENDED'}" class="badge bg-success ms-2">已续约</span>
                                        </h6>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> 
                                                <span th:text="${#temporals.format(res.startTime, 'MM-dd HH:mm')}"></span>
                                                至 <span th:text="${#temporals.format(res.endTime, 'MM-dd HH:mm')}"></span>
                                            </small>
                                        </p>
                                        <p th:if="${res.remarks != null and !res.remarks.isEmpty()}" class="card-text">
                                            <small><i class="fas fa-sticky-note"></i> <span th:text="${res.remarks}"></span></small>
                                        </p>
                                        
                                        <!-- 剩余时间显示 -->
                                        <div class="countdown" th:id="'countdown-' + ${res.id}">
                                            <i class="fas fa-hourglass-half"></i> 计算中...
                                        </div>
                                        
                                        <!-- 续约次数显示 -->
                                        <div th:if="${res.extensionCount > 0}" class="mt-2">
                                            <small class="text-info">
                                                <i class="fas fa-redo"></i> 已续约 <span th:text="${res.extensionCount}"></span> 次
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4 text-end">
                                        <!-- 退座按钮 -->
                                        <button class="btn btn-danger btn-sm mb-2" 
                                                th:onclick="'checkOut(' + ${res.id} + ')'">
                                            <i class="fas fa-sign-out-alt"></i> 退座
                                        </button>
                                        
                                        <!-- 取消预约按钮 -->
                                        <form th:action="@{'/reservations/cancel/' + ${res.id}}" method="post" 
                                              class="d-inline" onsubmit="return confirm('确定要取消预约吗？');">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-times"></i> 取消
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- 续约控制面板 -->
                                <div class="extend-controls mt-3" th:id="'extend-panel-' + ${res.id}" style="display: none;">
                                    <h6><i class="fas fa-clock"></i> 续约申请</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select class="form-select form-select-sm" th:id="'hours-' + ${res.id}">
                                                <option value="1">续约 1 小时</option>
                                                <option value="2">续约 2 小时</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-success btn-sm me-2" 
                                                    th:onclick="'extendReservation(' + ${res.id} + ')'">
                                                <i class="fas fa-plus"></i> 确认续约
                                            </button>
                                            <button class="btn btn-secondary btn-sm" 
                                                    th:onclick="'hideExtendPanel(' + ${res.id} + ')'">
                                                取消
                                            </button>
                                        </div>
                                    </div>
                                    <small class="text-muted mt-2 d-block">
                                        <i class="fas fa-info-circle"></i> 
                                        只能在预约结束前30分钟内申请续约，每个预约最多续约3次
                                    </small>
                                </div>
                                
                                <!-- 续约按钮 -->
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm extend-btn" 
                                            th:id="'extend-btn-' + ${res.id}"
                                            th:onclick="'showExtendPanel(' + ${res.id} + ')'">
                                        <i class="fas fa-clock"></i> 申请续约
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// 格式化时间为本地时间格式
function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// 计算剩余时间
function updateCountdown() {
    const reservations = /*[[${reservations}]]*/ [];
    
    reservations.forEach(function(reservation) {
        const endTime = new Date(reservation.endTime);
        const now = new Date();
        const diff = endTime - now;
        
        const countdownEl = document.getElementById('countdown-' + reservation.id);
        const extendBtn = document.getElementById('extend-btn-' + reservation.id);
        
        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            countdownEl.innerHTML = '<i class="fas fa-hourglass-half"></i> 剩余 ' + hours + ' 小时 ' + minutes + ' 分钟';
            
            // 如果剩余时间少于30分钟且续约次数少于3次，显示续约按钮
            if (diff <= 30 * 60 * 1000 && reservation.extensionCount < 3) {
                extendBtn.style.display = 'inline-block';
                countdownEl.className = 'countdown';
                countdownEl.closest('.reservation-card').classList.add('ending-soon');
            } else {
                extendBtn.style.display = 'none';
                countdownEl.closest('.reservation-card').classList.remove('ending-soon');
            }
        } else {
            countdownEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 预约已过期';
            extendBtn.style.display = 'none';
        }
    });
}

// 显示续约面板
function showExtendPanel(reservationId) {
    document.getElementById('extend-panel-' + reservationId).style.display = 'block';
    document.getElementById('extend-btn-' + reservationId).style.display = 'none';
}

// 隐藏续约面板
function hideExtendPanel(reservationId) {
    document.getElementById('extend-panel-' + reservationId).style.display = 'none';
    document.getElementById('extend-btn-' + reservationId).style.display = 'inline-block';
}

// 续约预约
function extendReservation(reservationId) {
    const hours = document.getElementById('hours-' + reservationId).value;
    
    fetch('/reservations/extend/' + reservationId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'hours=' + hours
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('续约成功！\n' + data.message);
            location.reload(); // 刷新页面以显示最新状态
        } else {
            alert('续约失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('续约请求失败，请稍后再试');
    });
}

// 退座
function checkOut(reservationId) {
    if (!confirm('确定要退座吗？退座后将无法恢复预约。')) {
        return;
    }
    
    fetch('/reservations/checkout/' + reservationId, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('退座成功！\n' + data.message);
            location.reload(); // 刷新页面
        } else {
            alert('退座失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('退座请求失败，请稍后再试');
    });
}

// 设置默认时间
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const startInput = document.getElementById('startTime');
    const endInput = document.getElementById('endTime');
    
    // 设置开始时间为下一个整点
    const nextHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours() + 1, 0);
    startInput.value = nextHour.toISOString().slice(0, 16);
    
    // 设置结束时间为开始时间后2小时
    const endTime = new Date(nextHour.getTime() + 2 * 60 * 60 * 1000);
    endInput.value = endTime.toISOString().slice(0, 16);
    
    // 开始倒计时更新
    updateCountdown();
    setInterval(updateCountdown, 60000); // 每分钟更新一次
});
</script>
</body>
</html> 